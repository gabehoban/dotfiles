#!{{ lookPath "bash" }}

set -euo pipefail

[ -d /opt/homebrew ] && HOMEBREW_PREFIX="/opt/homebrew"
[ -d /home/linuxbrew/.linuxbrew ] && HOMEBREW_PREFIX="/home/linuxbrew/.linuxbrew"

if [ -z $HOMEBREW_PREFIX ]; then
  echo "Please install homebrew before running."
  exit 1
fi

$HOMEBREW_PREFIX/bin/brew bundle --no-lock -q --file=/dev/stdin <<EOF
# Common Homebrew
{{ range .packages.common.taps }}
tap {{ . | quote }}
{{ end }}
{{ range .packages.common.brews }}
brew {{ . | quote }}
{{ end }}
# Linux Specific
{{ if eq .chezmoi.os "linux" -}}
{{ range .packages.linux.taps }}
tap {{ . | quote }}
{{ end }}
{{ range .packages.linux.brews }}
brew {{ . | quote }}
{{ end }}
{{ end -}}
# Darwin Specific
{{ if eq .chezmoi.os "darwin" -}}
{{ range .packages.darwin.taps }}
tap {{ . | quote }}
{{ end }}
{{ range .packages.darwin.casks }}
cask {{ . | quote }}
{{ end }}
{{ range .packages.darwin.brews }}
cask {{ . | quote }}
{{ end }}
{{ end -}}
EOF

# Linux non-homebrew packages
{{ if eq .chezmoi.os "linux" -}}
cat <<EOF | xargs sudo dnf install -q -y
{{ range .packages.linux.dnf -}}
{{ . | quote }}
{{ end -}}
EOF
sudo dnf remove -q -y remmina firefox libreoffice 2>/dev/null

flatpak remote-add --user --if-not-exists flathub https://dl.flathub.org/repo/flathub.flatpakrepo
cat <<EOF | xargs flatpak install --or-update --noninteractive --user flathub
{{ range .packages.linux.flatpaks -}}
{{ . | quote }}
{{ end -}}
EOF
{{ range .packages.common.vscode -}}
flatpak --user run com.visualstudio.code --force --install-extension {{ . | quote }} 2>/dev/null
{{ end -}}
flatpak override --user --filesystem=/games com.valvesoftware.Steam

dconf load / < <(cat <<EOF
[org/gnome/Ptyxis]
default-profile-uuid='1db35af54f8a5dac7e1361826757a6c7'
font-name='JetBrainsMono Nerd Font 11'
profile-uuids=['1db35af54f8a5dac7e1361826757a6c7']
use-system-font=false
window-size=(uint32 282, uint32 62)

[org/gnome/Ptyxis/Profiles/1db35af54f8a5dac7e1361826757a6c7]
palette='dracula'

[org/gnome/shell/extensions/blur-my-shell/dash-to-dock]
blur=true
style-dash-to-dock=0

[org/gnome/shell/extensions/caffeine]
enable-fullscreen=false
indicator-position-max=3

[org/gnome/shell/extensions/dash-to-dock]
apply-custom-theme=true
dash-max-icon-size=55
dock-fixed=true
dock-position='BOTTOM'

[org/gnome/shell]
enabled-extensions=['background-logo@fedorahosted.org', 'user-theme@gnome-shell-extensions.gcampax.github.com', 'dash-to-dock@micxgx.gmail.com', 'blur-my-shell@aunetx', 'appindicatorsupport@rgcjonas.gmail.com']
favorite-apps=['org.gnome.Nautilus.desktop', 'org.gnome.Ptyxis.desktop', 'org.mozilla.firefox.desktop', 'com.visualstudio.code.desktop', 'com.valvesoftware.Steam.desktop', 'com.discordapp.Discord.desktop', 'io.gitlab.news_flash.NewsFlash.desktop', 'org.gnome.Settings.desktop']
last-selected-power-profile='performance'
EOF
)
{{ end -}}
